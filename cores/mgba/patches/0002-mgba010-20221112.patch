From a97e27823877b1f363f63cee15eb1efb4ea64e8a Mon Sep 17 00:00:00 2001
From: Vicki Pfau <vi@endrift.com>
Date: Tue, 11 Oct 2022 22:24:06 -0700
Subject: [PATCH 01/16] CMake: Bump verison

---
 version.cmake | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/version.cmake b/version.cmake
index e66142fbd..6e944fb6c 100644
--- a/version.cmake
+++ b/version.cmake
@@ -3,7 +3,7 @@ if(NOT PROJECT_NAME)
 endif()
 set(LIB_VERSION_MAJOR 0)
 set(LIB_VERSION_MINOR 10)
-set(LIB_VERSION_PATCH 0)
+set(LIB_VERSION_PATCH 1)
 set(LIB_VERSION_ABI 0.10)
 set(LIB_VERSION_STRING ${LIB_VERSION_MAJOR}.${LIB_VERSION_MINOR}.${LIB_VERSION_PATCH})
 set(SUMMARY "${PROJECT_NAME} Game Boy Advance Emulator")

From cd0042f83d3815b6fa5a62a3664f1a51b886fe77 Mon Sep 17 00:00:00 2001
From: Vicki Pfau <vi@endrift.com>
Date: Fri, 14 Oct 2022 21:33:38 -0700
Subject: [PATCH 02/16] Res: Fix species name location in Ruby/Sapphire revs
 1/2 (fixes #2685)

---
 CHANGES                 |  4 ++++
 res/scripts/pokemon.lua | 18 ++++++++++++++++++
 2 files changed, 22 insertions(+)

diff --git a/CHANGES b/CHANGES
index bab536240..b5df6a2be 100644
--- a/CHANGES
+++ b/CHANGES
@@ -1,3 +1,7 @@
+0.10.1: (Future)
+Other fixes:
+ - Res: Fix species name location in Ruby/Sapphire revs 1/2 (fixes mgba.io/i/2685)
+
 0.10.0: (2022-10-11)
 Features:
  - Preliminary Lua scripting support
diff --git a/res/scripts/pokemon.lua b/res/scripts/pokemon.lua
index 7ebe54bb8..d909396d0 100644
--- a/res/scripts/pokemon.lua
+++ b/res/scripts/pokemon.lua
@@ -412,6 +412,13 @@ local gameRubyEn = Generation3En:new{
 	_speciesNameTable=0x1f716c,
 }
 
+local gameRubyEnR1 = Generation3En:new{
+	name="Ruby (USA)",
+	_party=0x3004360,
+	_partyCount=0x3004350,
+	_speciesNameTable=0x1f7184,
+}
+
 local gameSapphireEn = Generation3En:new{
 	name="Sapphire (USA)",
 	_party=0x3004360,
@@ -419,6 +426,13 @@ local gameSapphireEn = Generation3En:new{
 	_speciesNameTable=0x1f70fc,
 }
 
+local gameSapphireEnR1 = Generation3En:new{
+	name="Sapphire (USA)",
+	_party=0x3004360,
+	_partyCount=0x3004350,
+	_speciesNameTable=0x1f7114,
+}
+
 local gameEmeraldEn = Generation3En:new{
 	name="Emerald (USA)",
 	_party=0x20244ec,
@@ -471,6 +485,10 @@ gameCrc32 = {
 	[0x7d527d62] = gameYellowEn,
 	[0x84ee4776] = gameFireRedEnR1,
 	[0xdaffecec] = gameLeafGreenEnR1,
+	[0x61641576] = gameRubyEnR1, -- Rev 1
+	[0xaeac73e6] = gameRubyEnR1, -- Rev 2
+	[0xbafedae5] = gameSapphireEnR1, -- Rev 1
+	[0x9cc4410e] = gameSapphireEnR1, -- Rev 2
 }
 
 function printPartyStatus(game, buffer)

From aeb2ac88deb9e6b28056712e88906aae9d312eae Mon Sep 17 00:00:00 2001
From: Vicki Pfau <vi@endrift.com>
Date: Fri, 14 Oct 2022 23:23:37 -0700
Subject: [PATCH 03/16] Qt: Manually split filename to avoid overzealous
 splitting (fixes #2681)

---
 CHANGES                                |  1 +
 src/platform/qt/ApplicationUpdater.cpp | 10 +++++++++-
 2 files changed, 10 insertions(+), 1 deletion(-)

diff --git a/CHANGES b/CHANGES
index b5df6a2be..36adbc375 100644
--- a/CHANGES
+++ b/CHANGES
@@ -1,5 +1,6 @@
 0.10.1: (Future)
 Other fixes:
+ - Qt: Manually split filename to avoid overzealous splitting (fixes mgba.io/i/2681)
  - Res: Fix species name location in Ruby/Sapphire revs 1/2 (fixes mgba.io/i/2685)
 
 0.10.0: (2022-10-11)
diff --git a/src/platform/qt/ApplicationUpdater.cpp b/src/platform/qt/ApplicationUpdater.cpp
index ce752ecce..f26e58101 100644
--- a/src/platform/qt/ApplicationUpdater.cpp
+++ b/src/platform/qt/ApplicationUpdater.cpp
@@ -137,7 +137,15 @@ QUrl ApplicationUpdater::parseManifest(const QByteArray& manifest) {
 QString ApplicationUpdater::destination() const {
 	QFileInfo path(updateInfo().url.path());
 	QDir dir(ConfigController::configDir());
-	return dir.filePath(QLatin1String("update.") + path.completeSuffix());
+	// QFileInfo::completeSuffix will eat all .'s in the filename...including
+	// ones in the version string, turning mGBA-1.0.0-win32.7z into
+	// 0.0-win32.7z instead of the intended .7z
+	// As a result, so we have to split out the complete suffix manually.
+	QString suffix(path.suffix());
+	if (path.completeBaseName().endsWith(".tar")) {
+		suffix = "tar." + suffix;
+	}
+	return dir.filePath(QLatin1String("update.") + suffix);
 }
 
 const char* ApplicationUpdater::platform() {

From 7f5962e5a8ae2bcbc67a0abc625313e71029aa16 Mon Sep 17 00:00:00 2001
From: Vicki Pfau <vi@endrift.com>
Date: Fri, 14 Oct 2022 23:35:32 -0700
Subject: [PATCH 04/16] Qt: Expand criteria for tag branch names (fixes #2679)

---
 CHANGES                                | 1 +
 src/platform/qt/ApplicationUpdater.cpp | 2 +-
 2 files changed, 2 insertions(+), 1 deletion(-)

diff --git a/CHANGES b/CHANGES
index 36adbc375..f4a1bc032 100644
--- a/CHANGES
+++ b/CHANGES
@@ -1,6 +1,7 @@
 0.10.1: (Future)
 Other fixes:
  - Qt: Manually split filename to avoid overzealous splitting (fixes mgba.io/i/2681)
+ - Qt: Expand criteria for tag branch names (fixes mgba.io/i/2679)
  - Res: Fix species name location in Ruby/Sapphire revs 1/2 (fixes mgba.io/i/2685)
 
 0.10.0: (2022-10-11)
diff --git a/src/platform/qt/ApplicationUpdater.cpp b/src/platform/qt/ApplicationUpdater.cpp
index f26e58101..4225bd7ee 100644
--- a/src/platform/qt/ApplicationUpdater.cpp
+++ b/src/platform/qt/ApplicationUpdater.cpp
@@ -73,7 +73,7 @@ QStringList ApplicationUpdater::listChannels() {
 QString ApplicationUpdater::currentChannel() {
 	QLatin1String version(projectVersion);
 	QLatin1String branch(gitBranch);
-	if (branch == QLatin1String("heads/") + version) {
+	if (branch == QLatin1String("heads/") + version || branch == version) {
 		return QLatin1String("stable");
 	} else {
 		return QLatin1String("dev");

From 28495ea73bb4e12918f96d6c35d32956c56930e4 Mon Sep 17 00:00:00 2001
From: Vicki Pfau <vi@endrift.com>
Date: Sun, 16 Oct 2022 01:31:01 -0700
Subject: [PATCH 05/16] Qt: Add missing Sachen MMC2 mapper

---
 src/platform/qt/GameBoy.cpp | 1 +
 1 file changed, 1 insertion(+)

diff --git a/src/platform/qt/GameBoy.cpp b/src/platform/qt/GameBoy.cpp
index e0271d322..3085a9ff0 100644
--- a/src/platform/qt/GameBoy.cpp
+++ b/src/platform/qt/GameBoy.cpp
@@ -39,6 +39,7 @@ static const QList<GBMemoryBankControllerType> s_mbcList{
 	GB_UNL_BBD,
 	GB_UNL_HITEK,
 	GB_UNL_SACHEN_MMC1,
+	GB_UNL_SACHEN_MMC2,
 };
 
 static QMap<GBModel, QString> s_gbModelNames;

From 2f3c62886469f07c38e25ce315c352def68ced70 Mon Sep 17 00:00:00 2001
From: Vicki Pfau <vi@endrift.com>
Date: Sun, 16 Oct 2022 03:29:36 -0700
Subject: [PATCH 06/16] README: Add MBC30 to the supported mappers list (closes
 #2686)

---
 README.md | 1 +
 1 file changed, 1 insertion(+)

diff --git a/README.md b/README.md
index 2d8837c53..4dfe0940f 100644
--- a/README.md
+++ b/README.md
@@ -50,6 +50,7 @@ The following mappers are fully supported:
 - MBC2
 - MBC3
 - MBC3+RTC
+- MBC30
 - MBC5
 - MBC5+Rumble
 - MBC7

From 3c64154f893ea7a8173718bcee882d4b7189b5e5 Mon Sep 17 00:00:00 2001
From: Vicki Pfau <vi@endrift.com>
Date: Sun, 16 Oct 2022 22:14:46 -0700
Subject: [PATCH 07/16] Qt: Fix e-Reader scanning function reentry (fixes
 #2693)

---
 CHANGES                            | 1 +
 src/platform/qt/CoreController.cpp | 6 +++++-
 2 files changed, 6 insertions(+), 1 deletion(-)

diff --git a/CHANGES b/CHANGES
index f4a1bc032..93418919c 100644
--- a/CHANGES
+++ b/CHANGES
@@ -2,6 +2,7 @@
 Other fixes:
  - Qt: Manually split filename to avoid overzealous splitting (fixes mgba.io/i/2681)
  - Qt: Expand criteria for tag branch names (fixes mgba.io/i/2679)
+ - Qt: Fix scanning specific e-Reader dotcodes (fixes mgba.io/i/2693)
  - Res: Fix species name location in Ruby/Sapphire revs 1/2 (fixes mgba.io/i/2685)
 
 0.10.0: (2022-10-11)
diff --git a/src/platform/qt/CoreController.cpp b/src/platform/qt/CoreController.cpp
index 61774de71..37fc1b01f 100644
--- a/src/platform/qt/CoreController.cpp
+++ b/src/platform/qt/CoreController.cpp
@@ -914,7 +914,10 @@ void CoreController::scanCard(const QString& path) {
 		if (!file.open(QIODevice::ReadOnly)) {
 			return;
 		}
-		m_eReaderData = file.read(2912);
+		QByteArray eReaderData = file.read(2912);
+		if (eReaderData.isEmpty()) {
+			return;
+		}
 
 		file.seek(0);
 		QStringList lines;
@@ -936,6 +939,7 @@ void CoreController::scanCard(const QString& path) {
 			}
 		}
 		scanCards(lines);
+		m_eReaderData = eReaderData;
 	} else if (image.size() == QSize(989, 44) || image.size() == QSize(639, 44)) {
 		const uchar* bits = image.constBits();
 		size_t size;

From e95842032a4f4e30b60b3783870d1bb8ccd414db Mon Sep 17 00:00:00 2001
From: Vicki Pfau <vi@endrift.com>
Date: Tue, 18 Oct 2022 01:39:15 -0700
Subject: [PATCH 08/16] GB Serialize: Don't write BGP/OBP when loading SCGB
 state (fixes #2694)

---
 CHANGES     | 2 ++
 src/gb/io.c | 2 +-
 2 files changed, 3 insertions(+), 1 deletion(-)

diff --git a/CHANGES b/CHANGES
index 93418919c..df09502d4 100644
--- a/CHANGES
+++ b/CHANGES
@@ -1,4 +1,6 @@
 0.10.1: (Future)
+Emulation fixes:
+ - GB Serialize: Don't write BGP/OBP when loading SCGB state (fixes mgba.io/i/2694)
 Other fixes:
  - Qt: Manually split filename to avoid overzealous splitting (fixes mgba.io/i/2681)
  - Qt: Expand criteria for tag branch names (fixes mgba.io/i/2679)
diff --git a/src/gb/io.c b/src/gb/io.c
index c6ad66c36..06a7927cd 100644
--- a/src/gb/io.c
+++ b/src/gb/io.c
@@ -754,7 +754,7 @@ void GBIODeserialize(struct GB* gb, const struct GBSerializedState* state) {
 	gb->video.renderer->writeVideoRegister(gb->video.renderer, GB_REG_SCX, state->io[GB_REG_SCX]);
 	gb->video.renderer->writeVideoRegister(gb->video.renderer, GB_REG_WY, state->io[GB_REG_WY]);
 	gb->video.renderer->writeVideoRegister(gb->video.renderer, GB_REG_WX, state->io[GB_REG_WX]);
-	if (gb->model & GB_MODEL_SGB) {
+	if (gb->model == GB_MODEL_SGB) {
 		gb->video.renderer->writeVideoRegister(gb->video.renderer, GB_REG_BGP, state->io[GB_REG_BGP]);
 		gb->video.renderer->writeVideoRegister(gb->video.renderer, GB_REG_OBP0, state->io[GB_REG_OBP0]);
 		gb->video.renderer->writeVideoRegister(gb->video.renderer, GB_REG_OBP1, state->io[GB_REG_OBP1]);

From 5b88f2c83b4b20b3bbdb64bfe7b21dedc2730fd1 Mon Sep 17 00:00:00 2001
From: Vicki Pfau <vi@endrift.com>
Date: Sat, 15 Oct 2022 16:47:49 -0700
Subject: [PATCH 09/16] macOS: Add category to plist (closes #2691)

---
 CHANGES           | 2 ++
 res/info.plist.in | 2 ++
 2 files changed, 4 insertions(+)

diff --git a/CHANGES b/CHANGES
index df09502d4..8b6d94bd7 100644
--- a/CHANGES
+++ b/CHANGES
@@ -6,6 +6,8 @@ Other fixes:
  - Qt: Expand criteria for tag branch names (fixes mgba.io/i/2679)
  - Qt: Fix scanning specific e-Reader dotcodes (fixes mgba.io/i/2693)
  - Res: Fix species name location in Ruby/Sapphire revs 1/2 (fixes mgba.io/i/2685)
+Misc:
+ - macOS: Add category to plist (closes mgba.io/i/2691)
 
 0.10.0: (2022-10-11)
 Features:
diff --git a/res/info.plist.in b/res/info.plist.in
index f37904dee..eb625299c 100644
--- a/res/info.plist.in
+++ b/res/info.plist.in
@@ -56,5 +56,7 @@
 			<string>Viewer</string>
 		</dict>
 	</array>
+	<key>LSApplicationCategoryType</key>
+	<string>public.app-category.games</string>
 </dict>
 </plist>

From 5be534ed0c97efb1b989e186b56110db67f4c05d Mon Sep 17 00:00:00 2001
From: Vicki Pfau <vi@endrift.com>
Date: Wed, 19 Oct 2022 04:15:41 -0700
Subject: [PATCH 10/16] Qt: Keep track of current pslette preset name (fixes
 #2680)

---
 CHANGES                          | 1 +
 src/platform/qt/SettingsView.cpp | 8 +++++++-
 2 files changed, 8 insertions(+), 1 deletion(-)

diff --git a/CHANGES b/CHANGES
index 8b6d94bd7..9adbe41c3 100644
--- a/CHANGES
+++ b/CHANGES
@@ -8,6 +8,7 @@ Other fixes:
  - Res: Fix species name location in Ruby/Sapphire revs 1/2 (fixes mgba.io/i/2685)
 Misc:
  - macOS: Add category to plist (closes mgba.io/i/2691)
+ - Qt: Keep track of current pslette preset name (fixes mgba.io/i/2680)
 
 0.10.0: (2022-10-11)
 Features:
diff --git a/src/platform/qt/SettingsView.cpp b/src/platform/qt/SettingsView.cpp
index 570b15d6c..cba481dc8 100644
--- a/src/platform/qt/SettingsView.cpp
+++ b/src/platform/qt/SettingsView.cpp
@@ -296,9 +296,14 @@ SettingsView::SettingsView(ConfigController* controller, InputController* inputC
 	}
 
 	const GBColorPreset* colorPresets;
+	QString usedPreset = m_controller->getQtOption("gb.pal").toString();
 	size_t nPresets = GBColorPresetList(&colorPresets);
 	for (size_t i = 0; i < nPresets; ++i) {
-		m_ui.colorPreset->addItem(QString(colorPresets[i].name));
+		QString presetName(colorPresets[i].name);
+		m_ui.colorPreset->addItem(presetName);
+		if (usedPreset == presetName) {
+			m_ui.colorPreset->setCurrentIndex(i);
+		}
 	}
 	connect(m_ui.colorPreset, static_cast<void (QComboBox::*)(int)>(&QComboBox::currentIndexChanged), this, [this, colorPresets](int n) {
 		const GBColorPreset* preset = &colorPresets[n];
@@ -640,6 +645,7 @@ void SettingsView::updateConfig() {
 		m_controller->setOption(color.toUtf8().constData(), m_gbColors[colorId] & ~0xFF000000);
 
 	}
+	m_controller->setQtOption("gb.pal", m_ui.colorPreset->currentText());
 
 	int gbColors = GB_COLORS_CGB;
 	if (m_ui.gbColor->isChecked()) {

From 9b31835d22f64886c0aa582b6c261e74b7de7670 Mon Sep 17 00:00:00 2001
From: Vicki Pfau <vi@endrift.com>
Date: Thu, 20 Oct 2022 20:11:19 -0700
Subject: [PATCH 11/16] macOS: Fix modern build with libepoxy (fixes #2700)

---
 CHANGES        | 1 +
 CMakeLists.txt | 8 ++++++--
 2 files changed, 7 insertions(+), 2 deletions(-)

diff --git a/CHANGES b/CHANGES
index 9adbe41c3..3eda3187f 100644
--- a/CHANGES
+++ b/CHANGES
@@ -8,6 +8,7 @@ Other fixes:
  - Res: Fix species name location in Ruby/Sapphire revs 1/2 (fixes mgba.io/i/2685)
 Misc:
  - macOS: Add category to plist (closes mgba.io/i/2691)
+ - macOS: Fix modern build with libepoxy (fixes mgba.io/i/2700)
  - Qt: Keep track of current pslette preset name (fixes mgba.io/i/2680)
 
 0.10.0: (2022-10-11)
diff --git a/CMakeLists.txt b/CMakeLists.txt
index ce8e4d687..a00e93371 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -718,8 +718,12 @@ if (USE_LZMA)
 endif()
 
 if(USE_EPOXY)
-	list(APPEND FEATURE_SRC ${CMAKE_CURRENT_SOURCE_DIR}/src/platform/opengl/gl.c ${CMAKE_CURRENT_SOURCE_DIR}/src/platform/opengl/gles2.c)
-	list(APPEND FEATURE_DEFINES BUILD_GL BUILD_GLES2 BUILD_GLES3)
+	if(NOT APPLE OR NOT MACOSX_SDK VERSION_GREATER 10.14)
+		list(APPEND FEATURE_SRC ${CMAKE_CURRENT_SOURCE_DIR}/src/platform/opengl/gl.c)
+		list(APPEND FEATURE_DEFINES BUILD_GL)
+	endif()
+	list(APPEND FEATURE_SRC ${CMAKE_CURRENT_SOURCE_DIR}/src/platform/opengl/gles2.c)
+	list(APPEND FEATURE_DEFINES BUILD_GLES2 BUILD_GLES3)
 	list(APPEND FEATURES EPOXY)
 	include_directories(AFTER ${EPOXY_INCLUDE_DIRS})
 	link_directories(${EPOXY_LIBRARY_DIRS})

From 5fbdef279f52a01cd526f43021703969fa42ef34 Mon Sep 17 00:00:00 2001
From: Vicki Pfau <vi@endrift.com>
Date: Thu, 27 Oct 2022 02:24:39 -0700
Subject: [PATCH 12/16] Updater: Fix mUpdaterGetUpdateForChannel

---
 src/feature/updater.c | 9 +--------
 1 file changed, 1 insertion(+), 8 deletions(-)

diff --git a/src/feature/updater.c b/src/feature/updater.c
index 442a71648..e9f47f440 100644
--- a/src/feature/updater.c
+++ b/src/feature/updater.c
@@ -78,14 +78,7 @@ static void _updateMatch(const char* key, const char* value, void* user) {
 		return;
 	}
 	const char* item = &key[dotLoc + 1];
-
-	struct Table* out = user;
-	struct mUpdate* update = HashTableLookup(out, match->channel);
-	if (!update) {
-		update = calloc(1, sizeof(*update));
-		HashTableInsert(out, match->channel, update);
-	}
-	_updateUpdate(update, item, value);
+	_updateUpdate(match->out, item, value);
 }
 
 bool mUpdaterInit(struct mUpdaterContext* context, const char* manifest) {

From a2c36134c3d06f40e58a3eee4b3a0216c3334008 Mon Sep 17 00:00:00 2001
From: Vicki Pfau <vi@endrift.com>
Date: Sat, 29 Oct 2022 01:38:34 -0700
Subject: [PATCH 13/16] VFS: Fix minizip write returning 0 on success instead
 of size

---
 CHANGES                | 1 +
 src/util/vfs/vfs-zip.c | 6 +++++-
 2 files changed, 6 insertions(+), 1 deletion(-)

diff --git a/CHANGES b/CHANGES
index 3eda3187f..b021866d4 100644
--- a/CHANGES
+++ b/CHANGES
@@ -6,6 +6,7 @@ Other fixes:
  - Qt: Expand criteria for tag branch names (fixes mgba.io/i/2679)
  - Qt: Fix scanning specific e-Reader dotcodes (fixes mgba.io/i/2693)
  - Res: Fix species name location in Ruby/Sapphire revs 1/2 (fixes mgba.io/i/2685)
+ - VFS: Fix minizip write returning 0 on success instead of size
 Misc:
  - macOS: Add category to plist (closes mgba.io/i/2691)
  - macOS: Fix modern build with libepoxy (fixes mgba.io/i/2700)
diff --git a/src/util/vfs/vfs-zip.c b/src/util/vfs/vfs-zip.c
index 2d353c566..2f8234b94 100644
--- a/src/util/vfs/vfs-zip.c
+++ b/src/util/vfs/vfs-zip.c
@@ -593,7 +593,11 @@ ssize_t _vfzRead(struct VFile* vf, void* buffer, size_t size) {
 
 ssize_t _vfzWrite(struct VFile* vf, const void* buffer, size_t size) {
 	struct VFileZip* vfz = (struct VFileZip*) vf;
-	return zipWriteInFileInZip(vfz->z, buffer, size);
+	int res = zipWriteInFileInZip(vfz->z, buffer, size);
+	if (res != ZIP_OK) {
+		return res;
+	}
+	return size;
 }
 
 void* _vfzMap(struct VFile* vf, size_t size, int flags) {

From 2369e22395bd3213c977ffdc726cc60b5e85117c Mon Sep 17 00:00:00 2001
From: Vicki Pfau <vi@endrift.com>
Date: Mon, 7 Nov 2022 20:43:22 -0800
Subject: [PATCH 14/16] GBA Video: Ignore disabled backgrounds as OBJ blend
 target (fixes #2489)

---
 CHANGES                                          |   1 +
 .../baseline_0000.png                            | Bin 0 -> 2190 bytes
 .../blend/disabled-bg-semitrans-blend/config.ini |   3 +++
 .../blend/disabled-bg-semitrans-blend/test.gba   | Bin 0 -> 5288 bytes
 src/gba/renderers/software-obj.c                 |   8 ++++----
 5 files changed, 8 insertions(+), 4 deletions(-)
 create mode 100644 cinema/gba/blend/disabled-bg-semitrans-blend/baseline_0000.png
 create mode 100644 cinema/gba/blend/disabled-bg-semitrans-blend/config.ini
 create mode 100644 cinema/gba/blend/disabled-bg-semitrans-blend/test.gba

diff --git a/CHANGES b/CHANGES
index b021866d4..4c7ec5430 100644
--- a/CHANGES
+++ b/CHANGES
@@ -1,6 +1,7 @@
 0.10.1: (Future)
 Emulation fixes:
  - GB Serialize: Don't write BGP/OBP when loading SCGB state (fixes mgba.io/i/2694)
+ - GBA Video: Ignore disabled backgrounds as OBJ blend target (fixes mgba.io/i/2489)
 Other fixes:
  - Qt: Manually split filename to avoid overzealous splitting (fixes mgba.io/i/2681)
  - Qt: Expand criteria for tag branch names (fixes mgba.io/i/2679)
diff --git a/cinema/gba/blend/disabled-bg-semitrans-blend/baseline_0000.png b/cinema/gba/blend/disabled-bg-semitrans-blend/baseline_0000.png
new file mode 100644
index 0000000000000000000000000000000000000000..f90f448c4f4370b0457759cc9891539d6d667ded
GIT binary patch
literal 2190
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

literal 0
HcmV?d00001

diff --git a/cinema/gba/blend/disabled-bg-semitrans-blend/config.ini b/cinema/gba/blend/disabled-bg-semitrans-blend/config.ini
new file mode 100644
index 000000000..f26f6d8b1
--- /dev/null
+++ b/cinema/gba/blend/disabled-bg-semitrans-blend/config.ini
@@ -0,0 +1,3 @@
+[testinfo]
+skip=10
+frames=1
diff --git a/cinema/gba/blend/disabled-bg-semitrans-blend/test.gba b/cinema/gba/blend/disabled-bg-semitrans-blend/test.gba
new file mode 100644
index 0000000000000000000000000000000000000000..91cb67e5f614b4a906973c9741a331d7a7bae870
GIT binary patch
literal 5288
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
C4c~nL

literal 0
HcmV?d00001

diff --git a/src/gba/renderers/software-obj.c b/src/gba/renderers/software-obj.c
index 8d67199ec..3b44d86a5 100644
--- a/src/gba/renderers/software-obj.c
+++ b/src/gba/renderers/software-obj.c
@@ -169,10 +169,10 @@ int GBAVideoSoftwareRendererPreprocessSprite(struct GBAVideoSoftwareRenderer* re
 	              (renderer->blendEffect == BLEND_BRIGHTEN || renderer->blendEffect == BLEND_DARKEN);
 	if (GBAObjAttributesAGetMode(sprite->a) == OBJ_MODE_SEMITRANSPARENT || (renderer->target1Obj && renderer->blendEffect == BLEND_ALPHA) || objwinSlowPath) {
 		int target2 = renderer->target2Bd;
-		target2 |= renderer->bg[0].target2;
-		target2 |= renderer->bg[1].target2;
-		target2 |= renderer->bg[2].target2;
-		target2 |= renderer->bg[3].target2;
+		target2 |= renderer->bg[0].target2 && renderer->bg[0].enabled;
+		target2 |= renderer->bg[1].target2 && renderer->bg[1].enabled;
+		target2 |= renderer->bg[2].target2 && renderer->bg[2].enabled;
+		target2 |= renderer->bg[3].target2 && renderer->bg[3].enabled;
 		if (target2) {
 			renderer->forceTarget1 = true;
 			flags |= FLAG_REBLEND;

From e308fc523dbdaf0465ed8b82aca14565e14f5a85 Mon Sep 17 00:00:00 2001
From: Vicki Pfau <vi@endrift.com>
Date: Sat, 12 Nov 2022 00:35:34 -0800
Subject: [PATCH 15/16] GBA: Fix resetting key IRQ state (fixes #2716)

---
 CHANGES       | 1 +
 src/gba/gba.c | 1 +
 2 files changed, 2 insertions(+)

diff --git a/CHANGES b/CHANGES
index 4c7ec5430..61920c60b 100644
--- a/CHANGES
+++ b/CHANGES
@@ -1,6 +1,7 @@
 0.10.1: (Future)
 Emulation fixes:
  - GB Serialize: Don't write BGP/OBP when loading SCGB state (fixes mgba.io/i/2694)
+ - GBA: Fix resetting key IRQ state (fixes mgba.io/i/2716)
  - GBA Video: Ignore disabled backgrounds as OBJ blend target (fixes mgba.io/i/2489)
 Other fixes:
  - Qt: Manually split filename to avoid overzealous splitting (fixes mgba.io/i/2681)
diff --git a/src/gba/gba.c b/src/gba/gba.c
index bd0353d0c..42891500e 100644
--- a/src/gba/gba.c
+++ b/src/gba/gba.c
@@ -213,6 +213,7 @@ void GBAReset(struct ARMCore* cpu) {
 	gba->earlyExit = false;
 	gba->dmaPC = 0;
 	gba->biosStall = 0;
+	gba->keysLast = 0x400;
 	if (gba->yankedRomSize) {
 		gba->memory.romSize = gba->yankedRomSize;
 		gba->memory.romMask = toPow2(gba->memory.romSize) - 1;

From 1d373048cd10edbb1b7d7d94ee1840ddb5f16b34 Mon Sep 17 00:00:00 2001
From: Vicki Pfau <vi@endrift.com>
Date: Sat, 12 Nov 2022 00:45:25 -0800
Subject: [PATCH 16/16] CHANGES: Spill chicken

---
 CHANGES | 12 ++++++------
 1 file changed, 6 insertions(+), 6 deletions(-)

diff --git a/CHANGES b/CHANGES
index 61920c60b..d4a840077 100644
--- a/CHANGES
+++ b/CHANGES
@@ -12,7 +12,7 @@ Other fixes:
 Misc:
  - macOS: Add category to plist (closes mgba.io/i/2691)
  - macOS: Fix modern build with libepoxy (fixes mgba.io/i/2700)
- - Qt: Keep track of current pslette preset name (fixes mgba.io/i/2680)
+ - Qt: Keep track of current palette preset name (fixes mgba.io/i/2680)
 
 0.10.0: (2022-10-11)
 Features:
@@ -22,7 +22,7 @@ Features:
  - Tool for converting scanned pictures of e-Reader cards to raw dotcode data
  - Options for muting when inactive, minimized, or for different players in multiplayer
  - Cheat code support in homebrew ports
- - Acclerometer and gyro support for controllers on PC
+ - Accelerometer and gyro support for controllers on PC
  - Support for combo "Super Game Boy Color" SGB + GBC ROM hacks
  - Improved support for HuC-3 mapper, including RTC
  - Support for 64 kiB SRAM saves used in some bootlegs
@@ -36,7 +36,7 @@ Emulation fixes:
  - ARM7: Fix unsigned multiply timing
  - GB: Copy logo from ROM if not running the BIOS intro (fixes mgba.io/i/2378)
  - GB: Fix HALT breaking M-cycle alignment (fixes mgba.io/i/250)
- - GB Audio: Fix channel 1/2 reseting edge cases (fixes mgba.io/i/1925)
+ - GB Audio: Fix channel 1/2 resetting edge cases (fixes mgba.io/i/1925)
  - GB Audio: Properly apply per-model audio differences
  - GB Audio: Revamp channel rendering
  - GB Audio: Fix APU re-enable timing glitch
@@ -146,7 +146,7 @@ Emulation fixes:
 Other fixes:
  - ARM Decoder: Fix decoding of lsl r0 (fixes mgba.io/i/2349)
  - FFmpeg: Don't attempt to use YUV 4:2:0 for lossless videos (fixes mgba.io/i/2084)
- - GB Video: Fix memory leak when reseting SGB games
+ - GB Video: Fix memory leak when resetting SGB games
  - GBA: Fix out of bounds ROM accesses on patched ROMs smaller than 32 MiB
  - GBA: Fix maximum tile ID in caching for 256-color modes
  - GBA Video: Fix cache updating with proxy and GL renderers
@@ -257,7 +257,7 @@ Emulation fixes:
  - GBA BIOS: Implement dummy sound driver calls
  - GBA BIOS: Improve HLE BIOS timing
  - GBA BIOS: Fix reloading video registers after reset (fixes mgba.io/i/1808)
- - GBA BIOS: Make HLE BIOS calls interruptable (fixes mgba.io/i/1711 and mgba.io/i/1823)
+ - GBA BIOS: Make HLE BIOS calls interruptible (fixes mgba.io/i/1711 and mgba.io/i/1823)
  - GBA BIOS: Fix invalid decompression bounds checking
  - GBA DMA: Linger last DMA on bus (fixes mgba.io/i/301 and mgba.io/i/1320)
  - GBA DMA: Fix ordering and timing of overlapping DMAs
@@ -273,7 +273,7 @@ Emulation fixes:
  - GBA Serialize: Fix alignment check when loading states
  - GBA SIO: Fix copying Normal mode transfer values
  - GBA SIO: Fix Normal mode being totally broken (fixes mgba.io/i/1800)
- - GBA SIO: Fix deseralizing SIO registers
+ - GBA SIO: Fix deserializing SIO registers
  - GBA SIO: Fix hanging on starting a second multiplayer window (fixes mgba.io/i/854)
  - GBA SIO: Fix Normal mode transfer start timing (fixes mgba.io/i/425)
  - GBA Timers: Fix toggling timer cascading while timer is active (fixes mgba.io/i/2043)
